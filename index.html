<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gold Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; margin: 0; padding-bottom: 80px; }
        .header { background: linear-gradient(to bottom, #332a00, #000); padding: 30px; text-align: center; border-bottom: 1px solid #222; }
        .gold { color: #FFD700; }
        .balance { font-size: 3rem; font-weight: bold; margin: 10px 0; }
        
        .card { background: #111; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 15px; display: flex; justify-content: space-between; align-items: center; }
        .w-card { background: #1a1a1a; border: 1px solid #FFD700; border-radius: 12px; padding: 20px; margin: 15px; text-align: center; }
        
        .btn { background: #FFD700; color: #000; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-w { width: 100%; padding: 12px; font-size: 1rem; margin-top: 10px; }
        .btn:disabled { background: #333; color: #666; }
        
        .nav { position: fixed; bottom: 0; width: 100%; background: #0a0a0a; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #222; }
        .nav-item { color: #666; font-size: 0.8rem; text-align: center; }
        .nav-item.active { color: #FFD700; }
        
        .section { display: none; }
        .section.active { display: block; }
        #loader { text-align: center; padding: 20px; color: #FFD700; }
    </style>
</head>
<body>

    <div id="home" class="section active">
        <div class="header">
            <div id="uName">...</div>
            <div class="balance" id="uBal">0</div>
            <div class="gold">POINTS</div>
        </div>

        <div class="w-card">
            <h3>Withdraw Funds</h3>
            <p style="color:#888; font-size:0.9rem">Min: 10,000 Points</p>
            <div id="pendingMsg" style="display:none; color:orange">‚è≥ Processing...</div>
            <button id="btnWithdraw" class="btn btn-w" onclick="reqWithdraw()" disabled>Insufficient Balance</button>
        </div>

        <div class="card" style="display:block">
            <small style="color:#888">Your Referral Link</small>
            <div id="refLink" style="font-family:monospace; color:#FFD700; word-break:break-all; margin:5px 0;">...</div>
            <button class="btn" style="width:100%" onclick="copyRef()">Copy</button>
        </div>
    </div>

    <div id="tasks" class="section">
        <h2 class="gold" style="text-align:center">Tasks</h2>
        <div id="taskList"></div>
    </div>

    <div id="leaderboard" class="section">
        <h2 class="gold" style="text-align:center">Top 10</h2>
        <div id="lbList"></div>
    </div>

    <div id="loader">Loading Data...</div>

    <div class="nav">
        <div class="nav-item active" onclick="tab('home', this)">üè† Home</div>
        <div class="nav-item" onclick="tab('tasks', this)">üìã Tasks</div>
        <div class="nav-item" onclick="tab('leaderboard', this)">üèÜ Top</div>
    </div>

    <script>
        // === PASTE YOUR DEPLOYMENT URL HERE ===
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzJ3cvst5QZIVEeqYrRodjpCmywq-xrGAeUqbj7bNtKpRBxam3yZJYABLnALb1RqvF/exec'; 
        const BOT_USERNAME = 'UjGroup_BOT'; // Without @
        // ======================================

        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user;
        let balance = 0;

        async function init() {
            if(!user) return;
            document.getElementById('refLink').innerText = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ source:'webapp', action:'register', id:user.id, first_name:user.first_name })});
            loadData();
        }

        async function loadData() {
            document.getElementById('loader').style.display = 'block';
            const res = await fetch(`${SCRIPT_URL}?action=getData&userId=${user.id}`);
            const data = await res.json();
            
            document.getElementById('uName').innerText = data.user.name;
            document.getElementById('uBal').innerText = data.user.balance;
            balance = parseInt(data.user.balance);
            
            const wBtn = document.getElementById('btnWithdraw');
            const wMsg = document.getElementById('pendingMsg');
            if(data.user.pending) {
                wBtn.style.display = 'none';
                wMsg.style.display = 'block';
            } else {
                wBtn.style.display = 'block';
                wMsg.style.display = 'none';
                wBtn.disabled = balance < 10000;
                wBtn.innerText = balance < 10000 ? "Insufficient Balance" : "Request Withdrawal";
            }

            const tList = document.getElementById('taskList');
            tList.innerHTML = '';
            data.tasks.forEach(t => {
                tList.innerHTML += `<div class="card"><div><b>${t.desc}</b><br><small class="gold">+${t.reward}</small></div><button class="btn" onclick="doTask('${t.link}', ${t.reward})">Go</button></div>`;
            });

            const lList = document.getElementById('lbList');
            lList.innerHTML = '';
            data.leaderboard.forEach((u,i) => {
                lList.innerHTML += `<div class="card" style="margin:5px 15px"><span>#${i+1} ${u.name}</span><span class="gold">${u.balance}</span></div>`;
            });

            document.getElementById('loader').style.display = 'none';
        }

        async function reqWithdraw() {
            if(balance < 10000) return;
            if(!confirm(`Withdraw ${balance} points?`)) return;
            document.getElementById('btnWithdraw').innerText = "Sending...";
            await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ source:'webapp', action:'withdraw', userId:user.id, name:user.first_name, amount:balance })});
            loadData();
            alert("Request sent to Admin!");
        }

        function doTask(link, reward) {
            tg.openLink(link);
            setTimeout(async () => {
                if(confirm("Did you finish?")) {
                    await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ source:'webapp', action:'completeTask', userId:user.id, reward:reward })});
                    loadData();
                }
            }, 5000);
        }

        function tab(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        function copyRef() { navigator.clipboard.writeText(document.getElementById('refLink').innerText); alert("Copied"); }
        
        init();
    </script>
</body>
</html>
